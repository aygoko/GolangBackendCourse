**Задание: Интеграция RabbitMQ и разработка микросервисов для обработки задач**

---

### **Цель задания**  

Реализовать распределенную архитектуру, где HTTP-сервис взаимодействует с RabbitMQ для передачи задач, а микросервисы-обработчики (CodeProcessor или ImageProcessor) выполняют задачи в изолированных средах. Результаты обработки сохраняются через HTTP-интерфейс для тестирования, а инфраструктура развертывается через Docker Compose.  

---

### **Требования к функциональности**  
#### **1. Интеграция с RabbitMQ**

- Реализовать взаимодействие HTTP-сервиса с RabbitMQ:  
  - **Производитель (Producer):**  
    - При создании задачи (POST /task) отправлять сообщение в очередь RabbitMQ.  
    - Сообщение должно содержать `task_id` и параметры задачи (например, код или настройки фильтра).  
  - **Потребитель (Consumer):**  
    - Разработать микросервис (`CodeProcessor` или `ImageProcessor`), который:  
      - Подписывается на очередь RabbitMQ.  
      - Обрабатывает задачу и сохраняет результат через HTTP-эндпоинт `/commit`.  

#### **2. Реализация микросервисов**  
#### **CodeProcessor**  

- **Требования:**  
  - Создать Docker-контейнер с предустановленными компиляторами (`clang`, `gcc`) и интерпретатором (`Python`).  
  - Для каждой задачи:  
    1. Генерировать временный Docker-контейнер из базового образа.  
    2. Копировать пользовательский код в контейнер.  
    3. Компилировать/запускать код в изолированной среде.  
    4. Возвращать `stdout`, `stderr` и статус выполнения.  
  - Использовать библиотеку Docker SDK для Go (например, `github.com/docker/docker/client`).  

#### **ImageProcessor**  

- **Требования:**  
  - Реализовать обработку изображений с использованием библиотеки `disintegration/imaging`.  
  - Поддерживаемые фильтры:  
    - `Sharpen`, `Blur` (с параметрами).  
    - `Negative`, `FlipX` (базовые фильтры, реализованные самостоятельно).  
  - Формат входных данных: PNG.  
  - Формат выходных данных: Измененное изображение в формате PNG.  
  - Параметры фильтров передаются в JSON-объекте:  
    ```json  
    {  
      "filter": {  
        "name": "string",  
        "parameters": { ... }  
      }  
    }  
    ```  

#### **3. Коммит результатов** 

- Добавить HTTP-эндпоинт `/commit` в основной сервис:  
  - **POST /commit**  
    - **Body:** JSON с `task_id` и результатом (строка или бинарные данные изображения).  
    - **Ответ:** `200 OK` при успешном сохранении.  
  - Результаты хранятся в RAM-хеш-таблице до реализации БД.  

#### **4. Интеграция и тестирование**

- **Docker Compose:**  
  - Создать `docker-compose.yml` для развертывания:  
    - HTTP-сервис.  
    - RabbitMQ.  
    - Микросервис-обработчик (CodeProcessor или ImageProcessor).  
  - Настроить межконтейнерное взаимодействие.  

- **CI/CD:**  

  - Настроить GitHub Actions для:  
    - Сборки Docker-образов.  
    - Тестирования через `tests.py`.  
    - Проверки статуса сборки (зеленый статус).  

- **Makefile:**  

  - Добавить цели для:  
    - Запуска через Docker Compose.  
    - Запуска тестов.  
    - Сборки Docker-образов.  

---

### **Технические требования**  

- **Язык:** Go (версия 1.20+).  
- **Библиотеки:**  
  - Для RabbitMQ: `github.com/streadway/amqp`.  
  - Для Docker: `github.com/docker/docker/client`.  
  - Для обработки изображений: `github.com/disintegration/imaging`.  
- **Безопасность:**  
  - Все эндпоинты (кроме `/register` и `/login`) требуют аутентификации через токен.  
  - Использовать `bcrypt` для хэширования паролей.  

---

### **Структура кода**  

- **Микросервис-обработчик:**  
  - Разделить в отдельный репозиторий/пакет с собственным Dockerfile.  
  - Реализовать `main()` для запуска Consumer’а.  

- **Хранилище:**  
  - Обновить интерфейс `AuthStorage` для поддержки сессий и пользователей.  
  - Для временного хранения результатов использовать RAM-структуру.  

---

### **Проверка задания**  

1. **Запуск через Docker Compose:**  
   ```bash  
   make up  
   ```  
2. **Тестирование:**  
   - Регистрация пользователя → вход → отправка задачи.  
   - Проверка статуса задачи через `/status/{task_id}`.  
   - Получение результата через `/result/{task_id}` (для изображений: отображение в браузере).  
3. **CI/CD:**  
   - Убедиться, что GitHub Actions проходит успешно.  

---

### **Документация**  

- Обновить Swagger-документацию для новых эндпоинтов (`/commit`).  
- Добавить комментарии в код для генерации документации.  

---

### **Дополнительные требования**

- **Логирование:** Использовать `logrus` для отслеживания работы сервисов.  
- **Ошибки:** Обрабатывать исключения (например, ошибки компиляции/рендера изображений).  
- **Чистота кода:** Соблюдать стандарты Go (форматирование, анализ через `go vet`).  

---

**Срок сдачи:** 16.04.25
Отправить pull request в основной репозиторий курса.  

--- 

**Материалы:**  
- [RabbitMQ Tutorials](https://www.rabbitmq.com/tutorials)  
- [Фильтры для ImageProcessor](https://github.com/disintegration/imaging)  
- [Docker SDK для Go](https://github.com/docker/docker/tree/master/client)  
